<template>
    <div class="address-signup">
        <div>
            <div class="title-area">
                <p>ì£¼ë³€ ì¹œêµ¬ë“¤ë„ ì°¾ì•„ë³¼ê¹Œìš”?<br />ê±°ì£¼í•˜ì‹œëŠ” ë™ë„¤ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”ìš”! ğŸ‚</p>
            </div>
            <div class="input-area">
                <ScrollPicker v-model="selections" :options="options" />
            </div>
        </div>
        <div>
            <button class="full-width-primary-btn" :disabled="!isFilled" @click="nextStep">í™•ì¸</button>
        </div>
    </div>
</template>

<style lang="scss" scoped>
.address-signup {
    padding: 36px 24px;
    padding-top: 64px;
    height: calc(100dvh - 16px);
    display: flex;
    flex-direction: column;
    justify-content: space-between;

    >div {
        >.title-area {
            >p {
                word-break: keep-all;
                font-weight: 700;
                font-size: 24px;
                text-align: start;
            }
        }

        >.input-area {
            margin-top: 24px;
            padding: 8px 16px;
        }

        >button {
            font-weight: 700;
            font-size: 16px;
        }
    }
}
</style>

<script setup lang="js">
import { supabase } from '@/lib/supabase';
import { ref, computed, watch, defineEmits } from 'vue';
import ScrollPicker from 'vue3-scroll-picker';

const emit = defineEmits(); // ì´ë²¤íŠ¸ ì •ì˜

const selections = ref([]);
const isFilled = computed(() => selections.value);

// ì‹œ/ë„ ë°ì´í„°
const provinces = [
    { label: 'ì„œìš¸íŠ¹ë³„ì‹œ', value: 'ì„œìš¸íŠ¹ë³„ì‹œ' },
    { label: 'ë¶€ì‚°ê´‘ì—­ì‹œ', value: 'ë¶€ì‚°ê´‘ì—­ì‹œ' },
    { label: 'ì¸ì²œê´‘ì—­ì‹œ', value: 'ì¸ì²œê´‘ì—­ì‹œ' },
    { label: 'ëŒ€êµ¬ê´‘ì—­ì‹œ', value: 'ëŒ€êµ¬ê´‘ì—­ì‹œ' },
    { label: 'ê´‘ì£¼ê´‘ì—­ì‹œ', value: 'ê´‘ì£¼ê´‘ì—­ì‹œ' },
    { label: 'ëŒ€ì „ê´‘ì—­ì‹œ', value: 'ëŒ€ì „ê´‘ì—­ì‹œ' },
    { label: 'ìš¸ì‚°ê´‘ì—­ì‹œ', value: 'ìš¸ì‚°ê´‘ì—­ì‹œ' },
    { label: 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ', value: 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ' },
    { label: 'ê²½ê¸°ë„', value: 'ê²½ê¸°ë„' },
    { label: 'ê°•ì›íŠ¹ë³„ìì¹˜ë„', value: 'ê°•ì›íŠ¹ë³„ìì¹˜ë„' },
    { label: 'ì¶©ì²­ë¶ë„', value: 'ì¶©ì²­ë¶ë„' },
    { label: 'ì¶©ì²­ë‚¨ë„', value: 'ì¶©ì²­ë‚¨ë„' },
    { label: 'ê²½ìƒë¶ë„', value: 'ê²½ìƒë¶ë„' },
    { label: 'ê²½ìƒë‚¨ë„', value: 'ê²½ìƒë‚¨ë„' },
    { label: 'ì „ë¶íŠ¹ë³„ìì¹˜ë„', value: 'ì „ë¶íŠ¹ë³„ìì¹˜ë„' },
    { label: 'ì „ë¼ë‚¨ë„', value: 'ì „ë¼ë‚¨ë„' },
    { label: 'ì œì£¼íŠ¹ë³„ìì¹˜ë„', value: 'ì œì£¼íŠ¹ë³„ìì¹˜ë„' }
];

// ì‹œ/êµ°/êµ¬ ë°ì´í„°
const districts = {
    'ì„œìš¸íŠ¹ë³„ì‹œ': ['ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ìš©ì‚°êµ¬', 'ì„±ë™êµ¬', 'ê´‘ì§„êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘ë‘êµ¬', 'ì„±ë¶êµ¬', 'ê°•ë¶êµ¬', 'ë„ë´‰êµ¬', 'ë…¸ì›êµ¬', 'ì€í‰êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ë™ì‘êµ¬', 'ê´€ì•…êµ¬', 'ì„œì´ˆêµ¬', 'ê°•ë‚¨êµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬'],
    'ë¶€ì‚°ê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ì„œêµ¬', 'ë™êµ¬', 'ì˜ë„êµ¬', 'ë¶€ì‚°ì§„êµ¬', 'ë™ë˜êµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ê°•ì„œêµ¬', 'í•´ìš´ëŒ€êµ¬', 'ì‚¬í•˜êµ¬', 'ê¸ˆì •êµ¬', 'ì—°ì œêµ¬', 'ìˆ˜ì˜êµ¬', 'ì‚¬ìƒêµ¬', 'ê¸°ì¥êµ°'],
    'ì¸ì²œê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ë™êµ¬', 'ë¯¸ì¶”í™€êµ¬', 'ì—°ìˆ˜êµ¬', 'ë‚¨ë™êµ¬', 'ë¶€í‰êµ¬', 'ê³„ì–‘êµ¬', 'ì„œêµ¬', 'ê°•í™”êµ°', 'ì˜¹ì§„êµ°'],
    'ëŒ€êµ¬ê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ìˆ˜ì„±êµ¬', 'ë‹¬ì„œêµ¬', 'ë‹¬ì„±êµ°', 'êµ°ìœ„êµ°'],
    'ê´‘ì£¼ê´‘ì—­ì‹œ': ['ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ê´‘ì‚°êµ¬'],
    'ëŒ€ì „ê´‘ì—­ì‹œ': ['ë™êµ¬', 'ì¤‘êµ¬', 'ì„œêµ¬', 'ìœ ì„±êµ¬', 'ëŒ€ë•êµ¬'],
    'ìš¸ì‚°ê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ìš¸ì£¼êµ°'],
    'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': [],
    'ê²½ê¸°ë„': ['ê°€í‰êµ°', 'ê³ ì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'ê´‘ëª…ì‹œ', 'ê´‘ì£¼ì‹œ', 'êµ¬ë¦¬ì‹œ', 'êµ°í¬ì‹œ', 'ê¹€í¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'ë¶€ì²œì‹œ', 'ì„±ë‚¨ì‹œ', 'ìˆ˜ì›ì‹œ', 'ì‹œí¥ì‹œ', 'ì•ˆì‚°ì‹œ', 'ì•ˆì„±ì‹œ', 'ì•ˆì–‘ì‹œ', 'ì–‘ì£¼ì‹œ', 'ì–‘í‰êµ°', 'ì—¬ì£¼ì‹œ', 'ì—°ì²œêµ°', 'ì˜¤ì‚°ì‹œ', 'ìš©ì¸ì‹œ', 'ì˜ì™•ì‹œ', 'ì˜ì •ë¶€ì‹œ', 'ì´ì²œì‹œ', 'íŒŒì£¼ì‹œ', 'í‰íƒì‹œ', 'í¬ì²œì‹œ', 'í•˜ë‚¨ì‹œ', 'í™”ì„±ì‹œ'],
    'ê°•ì›íŠ¹ë³„ìì¹˜ë„': ['ì›ì£¼ì‹œ', 'ì¶˜ì²œì‹œ', 'ê°•ë¦‰ì‹œ', 'ë™í•´ì‹œ', 'ì†ì´ˆì‹œ', 'ì‚¼ì²™ì‹œ', 'í™ì²œêµ°', 'íƒœë°±ì‹œ', 'ì² ì›êµ°', 'íš¡ì„±êµ°', 'í‰ì°½êµ°', 'ì˜ì›”êµ°', 'ì •ì„ êµ°', 'ì¸ì œêµ°', 'ê³ ì„±êµ°', 'ì–‘ì–‘êµ°', 'í™”ì²œêµ°', 'ì–‘êµ¬êµ°'],
    'ì¶©ì²­ë¶ë„': ['ì²­ì£¼ì‹œ', 'ì¶©ì£¼ì‹œ', 'ì œì²œì‹œ', 'ë³´ì€êµ°', 'ì˜¥ì²œêµ°', 'ì˜ë™êµ°', 'ì¦í‰êµ°', 'ì§„ì²œêµ°', 'ê´´ì‚°êµ°', 'ìŒì„±êµ°', 'ë‹¨ì–‘êµ°'],
    'ì¶©ì²­ë‚¨ë„': ['ì²œì•ˆì‹œ', 'ê³µì£¼ì‹œ', 'ë³´ë ¹ì‹œ', 'ì•„ì‚°ì‹œ', 'ì„œì‚°ì‹œ', 'ë…¼ì‚°ì‹œ', 'ê³„ë£¡ì‹œ', 'ë‹¹ì§„ì‹œ', 'ê¸ˆì‚°êµ°', 'ë¶€ì—¬êµ°', 'ì„œì²œêµ°', 'ì²­ì–‘êµ°', 'í™ì„±êµ°', 'ì˜ˆì‚°êµ°', 'íƒœì•ˆêµ°'],
    'ê²½ìƒë¶ë„': ['í¬í•­ì‹œ', 'ê²½ì£¼ì‹œ', 'ê¹€ì²œì‹œ', 'ì•ˆë™ì‹œ', 'êµ¬ë¯¸ì‹œ', 'ì˜ì£¼ì‹œ', 'ì˜ì²œì‹œ', 'ìƒì£¼ì‹œ', 'ë¬¸ê²½ì‹œ', 'ê²½ì‚°ì‹œ', 'ì˜ì„±êµ°', 'ì²­ì†¡êµ°', 'ì˜ì–‘êµ°', 'ì˜ë•êµ°', 'ì²­ë„êµ°', 'ê³ ë ¹êµ°', 'ì„±ì£¼êµ°', 'ì¹ ê³¡êµ°', 'ì˜ˆì²œêµ°', 'ë´‰í™”êµ°', 'ìš¸ì§„êµ°', 'ìš¸ë¦‰êµ°'],
    'ê²½ìƒë‚¨ë„': ['ì°½ì›ì‹œ', 'ê¹€í•´ì‹œ', 'ì§„ì£¼ì‹œ', 'ì–‘ì‚°ì‹œ', 'ê±°ì œì‹œ', 'í†µì˜ì‹œ', 'ì‚¬ì²œì‹œ', 'ë°€ì–‘ì‹œ', 'í•¨ì•ˆêµ°', 'ê±°ì°½êµ°', 'ì°½ë…•êµ°', 'ê³ ì„±êµ°', 'í•˜ë™êµ°', 'í•©ì²œêµ°', 'ë‚¨í•´êµ°', 'í•¨ì–‘êµ°', 'ì‚°ì²­êµ°', 'ì˜ë ¹êµ°'],
    'ì „ë¶íŠ¹ë³„ìì¹˜ë„': ['ì „ì£¼ì‹œ', 'ìµì‚°ì‹œ', 'êµ°ì‚°ì‹œ', 'ì •ìì‹œ', 'ì™„ì£¼êµ°', 'ê¹€ì œì‹œ', 'ë‚¨ì›ì‹œ', 'ê³ ì°½êµ°', 'ë¶€ì•ˆêµ°', 'ì„ì‹¤êµ°', 'ìˆœì°½êµ°', 'ì§„ì•ˆêµ°', 'ì¥ìˆ˜êµ°', 'ë¬´ì£¼êµ°'],
    'ì „ë¼ë‚¨ë„': ['ì—¬ìˆ˜ì‹œ', 'ìˆœì²œì‹œ', 'ëª©í¬ì‹œ', 'ê´‘ì–‘ì‹œ', 'ë‚˜ì£¼ì‹œ', 'ë¬´ì•ˆêµ°', 'í•´ë‚¨êµ°', 'ê³ í¥êµ°', 'í™”ìˆœêµ°', 'ì˜ì•”êµ°', 'ì˜ê´‘êµ°', 'ì™„ë„êµ°', 'ë‹´ì–‘êµ°', 'ì¥ì„±êµ°', 'ë³´ì„±êµ°', 'ì‹ ì•ˆêµ°', 'ì¥í¥êµ°', 'ê°•ì§„êµ°', 'í•¨í‰êµ°', 'ì§„ë„êµ°', 'ê³¡ì„±êµ°', 'êµ¬ë¡€êµ°'],
    'ì œì£¼íŠ¹ë³„ìì¹˜ë„': ['ì œì£¼ì‹œ', 'ì„œê·€í¬ì‹œ']
};

const options = ref([
    provinces,
    [] // ì‹œ/êµ°/êµ¬ (ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸)
]);

// ì‹œ/ë„ ì„ íƒì— ë”°ë¼ ì‹œ/êµ°/êµ¬ ì—…ë°ì´íŠ¸
watch(() => selections.value[0], (newProvince) => {
    if (newProvince) {
        const districtList = districts[newProvince] || [];
        options.value[1] = districtList.map(district => ({
            label: district,
            value: district
        }));
        selections.value[1] = ''; // ì‹œ/êµ°/êµ¬ ì„ íƒ ì´ˆê¸°í™”
    }
});

const nextStep = async () => {
    // ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const [province, district] = selections.value;
    const address = [province, district];

    const { data: { session }, error: sessionError } = await supabase.auth.getSession(); // í˜„ì¬ ì„¸ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°

    if (sessionError || !session || !session.user) {
        console.error('ì„¸ì…˜ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return; // ì„¸ì…˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ
    }

    const userId = session.user.id; // UID ê°€ì ¸ì˜¤ê¸°

    const { error } = await supabase
        .from('users')
        .update({ address }) // ìƒì¼ ì—…ë°ì´íŠ¸
        .eq('id', userId); // UIDë¡œ ì¡°ê±´ ì„¤ì •

    if (error) {
        console.error('ë°ì´í„° ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    } else {
        emit('nextStep'); // ì´ë²¤íŠ¸ í˜¸ì¶œ
    }
}

</script>
